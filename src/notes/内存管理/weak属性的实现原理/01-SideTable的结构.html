<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SideTable</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/swift.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/objectivec.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        });
    </script>
    <script type="module" src="/mermaid-zoom.js"></script>
    <script src="/components/table-structure-component.js"></script>
    <script src="/table-structure-zoom.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sideTableData = {
                blocks: [
                    {
                        id: 'sidetable',
                        title: 'SideTable',
                        rows: [
                            { offset: 'refcnts', size: '引用计数表', linkTo: 'refcountmap' },
                            { offset: 'weak_table', size: 'weak表', linkTo: 'weaktable' }
                        ]
                    },
                    {
                        id: 'refcountmap',
                        title: 'refcnts（引用计数表）',
                        headers: [
                            { type: 'offset', text: 'Key（对象地址）' },
                            { type: 'size', text: 'Value（引用计数）' }
                        ],
                        rows: [
                            { offset: '0x1', size: '3' },
                            { offset: '0x2', size: '5' }
                        ]
                    },
                    {
                        id: 'weaktable',
                        title: 'weak_table（weak表）',
                        rows: [
                            { offset: 'weak_entries', size: '指向 weak_entry_t 数组的指针', linkTo: 'weakentries' },
                            { offset: 'num_entries', size: '条目数量 = 2' },
                            { offset: 'mask', size: '哈希表的掩码' },
                            { offset: 'max_hash_displacement', size: '最大哈希位移' }
                        ]
                    },
                    {
                        id: 'weakentries',
                        title: 'weak_entries 数组',
                        rows: [
                            { offset: 'weak_entry_t[0]', size: '对象p1的weak引用', linkTo: 'weakentry0' },
                            { offset: 'weak_entry_t[1]', size: '对象p2的weak引用', linkTo: 'weakentry1' }
                        ]
                    },
                    {
                        id: 'weakentry0',
                        title: 'weak_entry_t[0]（对象p1）',
                        rows: [
                            { offset: 'referent', size: 'DisguisedPtr<objc_object> - 对象地址 = 0x1（对象p1地址）' },
                            { offset: 'inline_referrers', size: 'WEAK_INLINE_COUNT - 内联数组（存储 weak 指针地址）' },
                            { offset: 'referrers', size: 'weak_referrer_t* - 动态分配的数组（当内联不够时）' },
                            { offset: 'out_of_line', size: 'uintptr_t - 标志位：是否使用动态数组' },
                            { offset: 'num_refs', size: 'uintptr_t - weak 引用数量' }
                        ]
                    },
                    {
                        id: 'weakentry1',
                        title: 'weak_entry_t[1]（对象p2）',
                        rows: [
                            { offset: 'referent', size: 'DisguisedPtr<objc_object> - 对象地址 = 0x2（对象p2地址）' },
                            { offset: 'inline_referrers', size: 'WEAK_INLINE_COUNT - 内联数组（存储 weak 指针地址）' },
                            { offset: 'referrers', size: 'weak_referrer_t* - 动态分配的数组（当内联不够时）' },
                            { offset: 'out_of_line', size: 'uintptr_t - 标志位：是否使用动态数组' },
                            { offset: 'num_refs', size: 'uintptr_t - weak 引用数量' }
                        ]
                    }
                ]
            };
            
            renderTableStructure(sideTableData, 'sidetable-container', { layout: 'hierarchical' });
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>SideTable</h1>
        
        <h2>概述</h2>
        <p>Side Table 是 iOS Runtime 中的一个辅助数据结构，用于存储对象的额外信息。当对象的 ISA 指针无法存储所有信息时（比如引用计数过大、需要 weak 引用等），系统会创建 Side Table 来存储这些信息。</p>
        
        <h2>实际存储结构</h2>
        <p><strong>假设场景</strong>：对象 p1（地址 0x1，引用计数=3，2个weak指针），对象 p2（地址 0x2，引用计数=5，2个weak指针）</p>
        
        <div id="sidetable-container"></div>
        
        <h2>各层结构说明</h2>
        <table>
            <thead>
                <tr>
                    <th>结构名称</th>
                    <th>类型</th>
                    <th>作用</th>
                    <th>层级</th>
                    <th>Key-Value关系</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>SideTable</strong></td>
                    <td>结构体</td>
                    <td>存储对象的额外信息</td>
                    <td>第1层</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td><strong>refcnts</strong></td>
                    <td>RefcountMap（哈希表）</td>
                    <td>存储引用计数</td>
                    <td>第2层</td>
                    <td>Key: 对象地址, Value: size_t（简单整数）</td>
                </tr>
                <tr>
                    <td><strong>weak_table</strong></td>
                    <td>weak_table_t（结构体）</td>
                    <td>哈希表结构，包含 weak_entries 数组指针和元数据</td>
                    <td>第2层</td>
                    <td>包含 weak_entries、num_entries、mask、max_hash_displacement 字段</td>
                </tr>
                <tr>
                    <td><strong>weak_entries</strong></td>
                    <td>weak_entry_t*（数组）</td>
                    <td>存储所有 weak_entry_t 的数组</td>
                    <td>第3层</td>
                    <td>数组元素为 weak_entry_t 结构体</td>
                </tr>
                <tr>
                    <td><strong>weak_entry_t</strong></td>
                    <td>结构体</td>
                    <td>存储单个对象的所有 weak 引用</td>
                    <td>第4层</td>
                    <td>包含 referent、inline_referrers、referrers 等字段</td>
                </tr>
            </tbody>
        </table>
        
        <h3>结构层级说明</h3>
        <ul>
            <li><strong>refcnts</strong>：
                <ul>
                    <li>SideTable → refcnts（类型为 RefcountMap，哈希表）</li>
                    <li>refcnts 中直接存储 Key-Value 对，Value 是简单的 size_t（整数）</li>
                    <li>不需要单独展示 RefcountEntry，因为它只是哈希表中的一个条目概念</li>
                </ul>
            </li>
            <li><strong>weak_table</strong>：
                <ul>
                    <li>SideTable → weak_table（类型为 weak_table_t，结构体）→ weak_entries（数组）→ weak_entry_t（结构体）</li>
                    <li>weak_table_t 是哈希表结构体，包含：
                        <ul>
                            <li>weak_entries：指向 weak_entry_t 数组的指针</li>
                            <li>num_entries：条目数量</li>
                            <li>mask：哈希表的掩码</li>
                            <li>max_hash_displacement：最大哈希位移</li>
                        </ul>
                    </li>
                    <li>weak_entries 数组存储所有 weak_entry_t 结构体</li>
                    <li>weak_entry_t 是一个独立的结构体，包含字段：referent（对象地址）、inline_referrers（内联数组）、referrers（动态数组）、out_of_line（标志位）、num_refs（引用数量）等</li>
                </ul>
            </li>
        </ul>
        
        <h2>存储位置</h2>
        <p>Side Table 存储在全局的 <strong>StripedMap</strong> 中（包含多个 SideTable 的数组），通过对象地址的哈希值选择使用哪个 SideTable。多个对象可以共享同一个 SideTable（通过 SideTable 内的哈希表区分）。</p>
    </div>
</body>
</html>
