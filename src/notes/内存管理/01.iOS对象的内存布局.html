<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS对象的内存布局</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/swift.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/objectivec.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll("pre code").forEach((block) => {
                hljs.highlightElement(block);
            });
        });
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script type="module" src="/mermaid-zoom.js"></script>
    <script src="/components/table-structure-component.js"></script>
    <script src="/table-structure-zoom.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const memoryData = {
                blocks: [
                    {
                        id: 'dog-structure',
                        title: 'Dog 对象内存布局',
                        rows: [
                            { offset: '偏移 0', name: 'isa', type: '指针', size: '8 字节', linkTo: 'isa-structure' },
                            { offset: '偏移 8', name: '_name', type: 'NSString *', size: '8 字节' },
                            { offset: '偏移 16', name: '_age', type: 'int', size: '4 字节' },
                            { offset: '偏移 20', desc: '对齐填充', size: '4 字节' }
                        ]
                    },
                    {
                        id: 'isa-structure',
                        title: 'isa 指针结构（NONPOINTER_ISA）',
                        rows: [
                            { offset: '位 0', name: 'nonpointer', size: '1=存储额外信息' },
                            { offset: '位 1', name: 'has_assoc', size: '是否有关联对象' },
                            { offset: '位 2', name: 'has_cxx_dtor', size: '是否有C++析构函数' },
                            { offset: '位 3-35', name: 'shiftcls', size: '类对象地址（33位）' },
                            { offset: '位 36-47', name: 'magic', size: '魔数（用于验证）' },
                            { offset: '位 48', name: 'weakly_referenced', size: '是否有弱引用' },
                            { offset: '位 49', name: 'deallocating', size: '是否正在释放' },
                            { offset: '位 50', name: 'has_sidetable_rc', size: '引用计数是否在SideTable' },
                            { offset: '位 51-63', name: 'extra_rc', size: '额外引用计数（19位）' }
                        ]
                    }
                ]
            };
            
            renderTableStructure(memoryData, 'memory-container');
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>iOS 对象的内存布局</h1>
        
        <h2>对象内存布局结构</h2>
        
        <div class="code-block"><code><span class="keyword">@interface</span> <span class="type">Animal</span> : <span class="type">NSObject</span> {
    <span class="type">NSString</span> *_name;
}
<span class="keyword">@end</span>

<span class="keyword">@interface</span> <span class="type">Dog</span> : <span class="type">Animal</span> {
    <span class="type">int</span> _age;
}
<span class="keyword">@end</span></code></div>
        
        <div id="memory-container"></div>
        
        <h2>内存布局说明</h2>
        <table>
            <thead>
                <tr>
                    <th>位置</th>
                    <th>内容</th>
                    <th>大小</th>
                    <th>说明</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>偏移 0</strong></td>
                    <td><code class="highlight">isa</code> 指针</td>
                    <td>8 字节</td>
                    <td>指向类对象，所有对象都有，偏移量固定为 0</td>
                </tr>
                <tr>
                    <td><strong>偏移 8</strong></td>
                    <td><code class="highlight">_name</code> (NSString *)</td>
                    <td>8 字节</td>
                    <td>来自 Animal 父类的实例变量</td>
                </tr>
                <tr>
                    <td><strong>偏移 16</strong></td>
                    <td><code class="highlight">_age</code> (int)</td>
                    <td>4 字节</td>
                    <td>来自 Dog 子类的实例变量</td>
                </tr>
                <tr>
                    <td><strong>偏移 20</strong></td>
                    <td>对齐填充</td>
                    <td>4 字节</td>
                    <td>使对象总大小为 24 字节（8 的倍数）</td>
                </tr>
            </tbody>
        </table>
        
        <h2>面试题：一个 NSObject 对象占用多少字节？</h2>
        <p><strong>注意</strong>：这个问题特指 <code class="highlight">NSObject</code> 这个基类对象，<strong>不是所有继承自 NSObject 的对象</strong>。</p>
        
        <h3>答案</h3>
        <p>需要区分两个概念：</p>
        
        <table>
            <thead>
                <tr>
                    <th>概念</th>
                    <th>API</th>
                    <th>NSObject 的结果</th>
                    <th>说明</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>对象实例大小</strong></td>
                    <td><code class="highlight">class_getInstanceSize</code></td>
                    <td>8 字节</td>
                    <td>对象实例变量实际占用的内存大小（只有 isa 指针）</td>
                </tr>
                <tr>
                    <td><strong>系统分配大小</strong></td>
                    <td><code class="highlight">malloc_size</code></td>
                    <td>16 字节</td>
                    <td>系统实际分配的内存大小（最小分配单位）</td>
                </tr>
            </tbody>
        </table>
        
        <h3>代码示例</h3>
        <div class="code-block"><code><span class="type">NSObject</span> *obj = [[<span class="type">NSObject</span> <span class="keyword">alloc</span>] <span class="keyword">init</span>];
<span class="type">size_t</span> instanceSize = <span class="function">class_getInstanceSize</span>([<span class="type">NSObject</span> <span class="keyword">class</span>]);
<span class="type">size_t</span> mallocSize = <span class="function">malloc_size</span>((__bridge <span class="type">const</span> <span class="type">void</span> *)obj);
<span class="function">NSLog</span>(<span class="string">@"实例大小: %zu, 分配大小: %zu"</span>, instanceSize, mallocSize);
<span class="comment">// 输出：实例大小: 8, 分配大小: 16</span></code></div>
        
        <h3>重要说明</h3>
        <table>
            <thead>
                <tr>
                    <th>对象类型</th>
                    <th>实例大小</th>
                    <th>系统分配大小</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>NSObject</strong></td>
                    <td>8 字节</td>
                    <td>16 字节</td>
                </tr>
                <tr>
                    <td><strong>有实例变量的对象</strong>（如 Dog）</td>
                    <td>8 + 实例变量大小</td>
                    <td>≥ 实例大小（取决于分配器）</td>
                </tr>
            </tbody>
        </table>
        
        <div class="warning">
            <p><strong>常见误解</strong>：认为所有继承自 NSObject 的对象都是 16 字节。</p>
            <p><strong>正确理解</strong>：只有 NSObject 本身是 8 字节（实例）/ 16 字节（分配）。有实例变量的对象大小会根据实例变量变化。</p>
        </div>
        
    </div>
</body>
</html>
