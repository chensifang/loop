<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ weak å…³é”®å­—æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</title>
    <link rel="stylesheet" href="../../style.css">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ weak å…³é”®å­—æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</h1>
        
        <h2>æ ¸å¿ƒæ¦‚å¿µ</h2>
        <p>weak å…³é”®å­—çš„å®ç°ä¾èµ–äº <strong>Side Table</strong> å’Œ <strong>weak è¡¨</strong>ã€‚å½“å¯¹è±¡è¢« weak å¼•ç”¨æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨ Side Table ä¸­è®°å½•è¿™ä¸ªå¼•ç”¨å…³ç³»ï¼Œå¯¹è±¡é‡Šæ”¾æ—¶è‡ªåŠ¨å°†æ‰€æœ‰ weak å¼•ç”¨ç½®ä¸º nilã€‚</p>
        
        <h2>Side Table çš„ç»“æ„</h2>
        <p>Side Table æ˜¯ä¸€ä¸ªè¾…åŠ©æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨å¯¹è±¡çš„é¢å¤–ä¿¡æ¯ï¼š</p>
        
        <table>
            <thead>
                <tr>
                    <th>å­˜å‚¨ä½ç½®</th>
                    <th>å­˜å‚¨å†…å®¹</th>
                    <th>è¯´æ˜</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>å¯¹è±¡æœ¬èº«</strong></td>
                    <td>ISA æŒ‡é’ˆã€æˆå‘˜å˜é‡</td>
                    <td>å¯¹è±¡çš„åŸºæœ¬ä¿¡æ¯</td>
                </tr>
                <tr>
                    <td><strong>Side Table</strong></td>
                    <td>å¼•ç”¨è®¡æ•°ã€weak è¡¨</td>
                    <td>å½“ ISA å­˜ä¸ä¸‹å¼•ç”¨è®¡æ•°æ—¶ï¼Œæˆ–éœ€è¦ weak å¼•ç”¨æ—¶ä½¿ç”¨</td>
                </tr>
            </tbody>
        </table>
        <div class="code-block"><pre><code>// Side Table çš„ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰
struct SideTable {
    spinlock_t slock;           // è‡ªæ—‹é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨
    RefcountMap refcnts;        // å¼•ç”¨è®¡æ•°è¡¨ï¼ˆå½“ ISA å­˜ä¸ä¸‹æ—¶ï¼‰
    weak_table_t weak_table;    // weak è¡¨
};

// weak è¡¨çš„ç»“æ„
struct weak_table_t {
    weak_entry_t *weak_entries;  // weak æ¡ç›®æ•°ç»„
    size_t num_entries;          // æ¡ç›®æ•°é‡
    uintptr_t mask;              // å“ˆå¸Œè¡¨çš„æ©ç 
    uintptr_t max_hash_displacement; // æœ€å¤§å“ˆå¸Œå†²çªè·ç¦»
};</code></pre></div>
        <h2>weak è¡¨çš„å·¥ä½œåŸç†</h2>
        <p>weak è¡¨æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œè®°å½•æ‰€æœ‰æŒ‡å‘æŸä¸ªå¯¹è±¡çš„ weak å¼•ç”¨ï¼š</p>
        
        <div class="mermaid">
graph LR
    A[å¯¹è±¡åœ°å€] --> B[weak è¡¨æŸ¥æ‰¾]
    B --> C[weak_entry_t]
    C --> D[weak å¼•ç”¨1çš„åœ°å€]
    C --> E[weak å¼•ç”¨2çš„åœ°å€]
    C --> F[weak å¼•ç”¨3çš„åœ°å€]
    
    style A fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#f3e5f5
    style E fill:#f3e5f5
    style F fill:#f3e5f5
        </div>
        
        <p><strong>ç®€å•ç†è§£</strong>ï¼šweak è¡¨å°±åƒä¸€ä¸ª"ç™»è®°ç°¿"ï¼Œè®°å½•"å“ªäº› weak å˜é‡æŒ‡å‘äº†æŸä¸ªå¯¹è±¡"ã€‚</p>
        
        <h2>weak å¼•ç”¨çš„å®Œæ•´æµç¨‹</h2>
        
        <h3>1. åˆ›å»º weak å¼•ç”¨æ—¶</h3>
        <div class="mermaid">
sequenceDiagram
    participant Code as ä»£ç 
    participant Compiler as ç¼–è¯‘å™¨
    participant Runtime as Runtime
    participant WeakTable as weak è¡¨
    
    Code->>Compiler: var weakVar: Person? = person
    Compiler->>Runtime: objc_initWeak(&weakVar, person)
    Runtime->>WeakTable: æŸ¥æ‰¾ person çš„ weak_entry
    WeakTable-->>Runtime: è¿”å›æˆ–åˆ›å»º entry
    Runtime->>WeakTable: å°† weakVar åœ°å€æ·»åŠ åˆ°åˆ—è¡¨
    Note over Runtime: ä¸å¢åŠ  person çš„å¼•ç”¨è®¡æ•°
        </div>
        
        <div class="code-block"><pre><code>// ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ï¼ˆç®€åŒ–ï¼‰
id obj1;
objc_initWeak(&obj1, person);  // åˆ›å»º weak å¼•ç”¨

// Runtime å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ï¼‰
void objc_initWeak(id *location, id newObj) {
    if (newObj) {
        // 1. æ‰¾åˆ°æˆ–åˆ›å»º weak_entry
        weak_entry_t *entry = weak_entry_for_referent(weak_table, newObj);
        
        // 2. å°† weak å¼•ç”¨çš„åœ°å€æ·»åŠ åˆ°åˆ—è¡¨ä¸­
        append_referrer(entry, location);
    }
    
    // 3. å°† location æŒ‡å‘ newObjï¼ˆä½†ä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼‰
    *location = newObj;
}</code></pre></div>
        <h3>2. å¯¹è±¡é‡Šæ”¾æ—¶</h3>
        <div class="mermaid">
sequenceDiagram
    participant Object as å¯¹è±¡
    participant Runtime as Runtime
    participant WeakTable as weak è¡¨
    participant WeakRefs as weak å¼•ç”¨åˆ—è¡¨
    
    Object->>Runtime: å¼•ç”¨è®¡æ•° = 0
    Runtime->>Runtime: è°ƒç”¨ dealloc
    Runtime->>WeakTable: æŸ¥æ‰¾å¯¹è±¡çš„ weak_entry
    WeakTable-->>Runtime: è¿”å› weak å¼•ç”¨åˆ—è¡¨
    Runtime->>WeakRefs: éå†æ‰€æœ‰ weak å¼•ç”¨
    Runtime->>WeakRefs: å°†æ‰€æœ‰ weak å¼•ç”¨ç½®ä¸º nil
    Runtime->>WeakTable: åˆ é™¤ weak_entry
        </div>
        
        <div class="code-block"><pre><code>// å¯¹è±¡é‡Šæ”¾æ—¶çš„å¤„ç†ï¼ˆç®€åŒ–ï¼‰
void objc_destructInstance(id obj) {
    // 1. æŸ¥æ‰¾ weak è¡¨
    weak_entry_t *entry = weak_entry_for_referent(weak_table, obj);
    
    if (entry) {
        // 2. éå†æ‰€æœ‰ weak å¼•ç”¨
        for (weak_referrer_t *referrer = entry->referrers; 
             referrer != NULL; 
             referrer++) {
            // 3. å°†æ¯ä¸ª weak å¼•ç”¨ç½®ä¸º nil
            *referrer = nil;
        }
        
        // 4. ä» weak è¡¨ä¸­åˆ é™¤è¯¥æ¡ç›®
        remove_referrer(entry);
    }
    
    // 5. é‡Šæ”¾å¯¹è±¡å†…å­˜
    object_dispose(obj);
}</code></pre></div>
        <h2>ä¸‰å±‚å“ˆå¸ŒæŸ¥æ‰¾</h2>
        <p>weak è¡¨çš„æŸ¥æ‰¾é‡‡ç”¨ä¸‰å±‚å“ˆå¸Œç»“æ„ï¼Œä¿è¯å¿«é€Ÿå®šä½ï¼š</p>
        
        <div class="mermaid">
graph TD
    A[å¯¹è±¡åœ°å€] --> B[ç¬¬ä¸€å±‚: Side Tables æ•°ç»„]
    B --> C[æ ¹æ®åœ°å€å“ˆå¸Œå€¼<br/>æ‰¾åˆ°å¯¹åº”çš„ Side Table]
    C --> D[ç¬¬äºŒå±‚: weak_table å“ˆå¸Œè¡¨]
    D --> E[æ ¹æ®å¯¹è±¡åœ°å€<br/>æ‰¾åˆ° weak_entry_t]
    E --> F[ç¬¬ä¸‰å±‚: weak_entry_t]
    F --> G[å­˜å‚¨æ‰€æœ‰ weak å¼•ç”¨åœ°å€]
    
    style A fill:#e1f5ff
    style C fill:#fff4e1
    style E fill:#f3e5f5
    style G fill:#e8f5e9
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>å±‚çº§</th>
                    <th>æ•°æ®ç»“æ„</th>
                    <th>æŸ¥æ‰¾æ–¹å¼</th>
                    <th>ä½œç”¨</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>ç¬¬ä¸€å±‚</strong></td>
                    <td>Side Tablesï¼ˆæ•°ç»„ï¼‰</td>
                    <td>å¯¹è±¡åœ°å€çš„å“ˆå¸Œå€¼å–æ¨¡</td>
                    <td>å®šä½åˆ°å¯¹åº”çš„ Side Table</td>
                </tr>
                <tr>
                    <td><strong>ç¬¬äºŒå±‚</strong></td>
                    <td>weak_tableï¼ˆå“ˆå¸Œè¡¨ï¼‰</td>
                    <td>å¯¹è±¡åœ°å€ä½œä¸º key</td>
                    <td>å®šä½åˆ° weak_entry_t</td>
                </tr>
                <tr>
                    <td><strong>ç¬¬ä¸‰å±‚</strong></td>
                    <td>weak_entry_tï¼ˆæ•°ç»„æˆ–å“ˆå¸Œè¡¨ï¼‰</td>
                    <td>çº¿æ€§æŸ¥æ‰¾æˆ–å“ˆå¸ŒæŸ¥æ‰¾</td>
                    <td>å­˜å‚¨æ‰€æœ‰æŒ‡å‘è¯¥å¯¹è±¡çš„ weak å¼•ç”¨åœ°å€</td>
                </tr>
            </tbody>
        </table>
        
        <h2>ä¸ºä»€ä¹ˆ weak å¿…é¡»æ˜¯å¯é€‰ç±»å‹ï¼Ÿ</h2>
        <p>weak å¼•ç”¨åœ¨å¯¹è±¡é‡Šæ”¾æ—¶ä¼šè¢«è‡ªåŠ¨ç½®ä¸º nilï¼Œæ‰€ä»¥å¿…é¡»æ˜¯å¯é€‰ç±»å‹ï¼ˆOptionalï¼‰ï¼Œå¦åˆ™æ— æ³•è¡¨ç¤º"æ²¡æœ‰å€¼"çš„çŠ¶æ€ã€‚</p>
        
        <div class="code-block"><pre><code>// âœ… æ­£ç¡®ï¼šweak å¿…é¡»æ˜¯å¯é€‰ç±»å‹
weak var person: Person? = Person()

// âŒ é”™è¯¯ï¼šç¼–è¯‘ä¸é€šè¿‡
weak var person: Person = Person()  // é”™è¯¯ï¼šweak å˜é‡å¿…é¡»æ˜¯å¯é€‰ç±»å‹

// å¯¹è±¡é‡Šæ”¾å
person = nil  // è‡ªåŠ¨ç½®ä¸º nilï¼Œå¯ä»¥å®‰å…¨è®¿é—®
if let p = person {
    // ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸º person å·²ç»æ˜¯ nil
}</code></pre></div>
        <h2>ä¸ unowned çš„åŒºåˆ«</h2>
        <table>
            <thead>
                <tr>
                    <th>ç‰¹æ€§</th>
                    <th>weak</th>
                    <th>unowned</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>å­˜å‚¨ä½ç½®</strong></td>
                    <td>Side Table çš„ weak è¡¨</td>
                    <td>ç›´æ¥å­˜å‚¨å¯¹è±¡åœ°å€ï¼ˆä¸è®°å½•ï¼‰</td>
                </tr>
                <tr>
                    <td><strong>è‡ªåŠ¨ç½® nil</strong></td>
                    <td>âœ… æ˜¯</td>
                    <td>âŒ å¦</td>
                </tr>
                <tr>
                    <td><strong>å¯¹è±¡é‡Šæ”¾åè®¿é—®</strong></td>
                    <td>å®‰å…¨ï¼ˆè¿”å› nilï¼‰</td>
                    <td>å´©æºƒï¼ˆé‡æŒ‡é’ˆï¼‰</td>
                </tr>
                <tr>
                    <td><strong>æ€§èƒ½å¼€é”€</strong></td>
                    <td>éœ€è¦æŸ¥æ‰¾ weak è¡¨</td>
                    <td>å‡ ä¹æ— å¼€é”€</td>
                </tr>
                <tr>
                    <td><strong>ç±»å‹è¦æ±‚</strong></td>
                    <td>å¿…é¡»æ˜¯å¯é€‰ç±»å‹</td>
                    <td>å¯ä»¥æ˜¯éå¯é€‰ç±»å‹</td>
                </tr>
            </tbody>
        </table>
        
        <p><strong>unowned çš„å®ç°æ›´ç®€å•</strong>ï¼šåªæ˜¯ä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä¸è®°å½•åœ¨ weak è¡¨ä¸­ï¼Œæ‰€ä»¥å¯¹è±¡é‡Šæ”¾æ—¶æ— æ³•è‡ªåŠ¨ç½® nilã€‚å¦‚æœå¯¹è±¡é‡Šæ”¾åè®¿é—® unowned å¼•ç”¨ï¼Œå°±ä¼šè®¿é—®é‡æŒ‡é’ˆå¯¼è‡´å´©æºƒã€‚</p>
        
        <h2>æ€§èƒ½è€ƒè™‘</h2>
        <table>
            <thead>
                <tr>
                <th>æ“ä½œ</th>
                <th>æ€§èƒ½å½±å“</th>
                <th>è¯´æ˜</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>åˆ›å»º weak å¼•ç”¨</strong></td>
                    <td>éœ€è¦æŸ¥æ‰¾ Side Table å’Œ weak è¡¨</td>
                    <td>æ¯”å¼ºå¼•ç”¨ç¨æ…¢ï¼Œä½†å½±å“å¾ˆå°</td>
                </tr>
                <tr>
                    <td><strong>è®¿é—® weak å¼•ç”¨</strong></td>
                    <td>éœ€è¦ä» weak è¡¨ä¸­è¯»å–</td>
                    <td>æ¯”å¼ºå¼•ç”¨ç¨æ…¢</td>
                </tr>
                <tr>
                    <td><strong>å¯¹è±¡é‡Šæ”¾æ—¶</strong></td>
                    <td>éœ€è¦éå† weak è¡¨ï¼Œç½® nil</td>
                    <td>æœ‰é¢å¤–å¼€é”€ï¼Œä½†ä¿è¯äº†å†…å­˜å®‰å…¨</td>
                </tr>
            </tbody>
        </table>
        
        <h2>æ€»ç»“</h2>
        <p>weak å…³é”®å­—çš„å®ç°æ ¸å¿ƒï¼š</p>
        <ol>
            <li><strong>ä½¿ç”¨ Side Table å­˜å‚¨ weak è¡¨</strong>ï¼šweak è¡¨è®°å½•æ‰€æœ‰æŒ‡å‘æŸä¸ªå¯¹è±¡çš„ weak å¼•ç”¨</li>
            <li><strong>ä¸‰å±‚å“ˆå¸ŒæŸ¥æ‰¾</strong>ï¼šé€šè¿‡ Side Tables â†’ weak_table â†’ weak_entry_t å¿«é€Ÿå®šä½</li>
            <li><strong>å¯¹è±¡é‡Šæ”¾æ—¶è‡ªåŠ¨ç½® nil</strong>ï¼šéå† weak è¡¨ï¼Œå°†æ‰€æœ‰ weak å¼•ç”¨ç½®ä¸º nil</li>
            <li><strong>å¿…é¡»æ˜¯å¯é€‰ç±»å‹</strong>ï¼šå› ä¸ºéœ€è¦è¡¨ç¤º nil çŠ¶æ€</li>
        </ol>
        
        <p><strong>å…³é”®ç‚¹</strong>ï¼šweak çš„å®ç°ä¿è¯äº†å†…å­˜å®‰å…¨ï¼Œå³ä½¿å¯¹è±¡è¢«é‡Šæ”¾ï¼Œweak å¼•ç”¨ä¹Ÿä¸ä¼šå˜æˆé‡æŒ‡é’ˆï¼Œè€Œæ˜¯è‡ªåŠ¨å˜æˆ nilï¼Œå¯ä»¥å®‰å…¨è®¿é—®ã€‚</p>
    </div>
</body>
</html>
